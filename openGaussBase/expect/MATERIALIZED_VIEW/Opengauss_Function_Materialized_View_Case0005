-- @testpoint: 测试修改物化视图，合理报错
--修改物化视图
drop table if exists student cascade;
SQL SUCCESS
drop user if exists mv_test;
SQL SUCCESS
create table student
(
    id int primary key,
    name varchar(10) not null
);
SQL SUCCESS
insert into student values (1, 'aaa');
SQL SUCCESS
insert into student values (2, 'bbb');
SQL SUCCESS
insert into student values (3, 'ccc');
SQL SUCCESS
insert into student values (4, 'ddd');
SQL SUCCESS
insert into student values (5, 'eee');
SQL SUCCESS
insert into student values (6, 'fff');
SQL SUCCESS
create materialized view student_mv (id, name) with (FILLFACTOR=60,COMPRESSION=NO) as select * from student;
SQL SUCCESS
select * from student_mv;
+----+------+
| id | name |
+----+------+
| 1  | aaa  |
| 2  | bbb  |
| 3  | ccc  |
| 4  | ddd  |
| 5  | eee  |
| 6  | fff  |
+----+------+
--修改物化视图action
--为后续的ANALYZE操作设置针对每列的统计收集目标
alter materialized view student_mv alter id set statistics 300;
SQL SUCCESS
alter materialized view student_mv alter column id set statistics percent 30;
SQL SUCCESS
--设置或重置每个属性的选项
alter materialized view student_mv alter id set (n_distinct=50);
SQL SUCCESS
alter materialized view student_mv alter column id reset (n_distinct);
SQL SUCCESS
--为一列设置存储模式
alter materialized view student_mv alter id set storage plain;
SQL SUCCESS
--为未来的cluster操作选择或移除默认索引
create unique index index_test on student_mv(name);
SQL SUCCESS
alter materialized view student_mv cluster on index_test;
SQL SUCCESS
alter materialized view student_mv set without cluster;
SQL SUCCESS
--设置或重置存储参数
alter materialized view student_mv set (FILLFACTOR=60,COMPRESSION=NO);
SQL SUCCESS
alter materialized view student_mv set (orientation=column);
?.*ERROR: Un-support feature
  Detail: Option "orientation" doesn't allow ALTER
alter materialized view student_mv reset (FILLFACTOR, COMPRESSION);
SQL SUCCESS
alter materialized view student_mv reset (orientation);
?.*ERROR: Un-support feature
  Detail: Option "orientation" doesn't allow ALTER
--修改物化视图属主
create user mv_test identified by 'test@123';
SQL SUCCESS
alter materialized view student_mv owner to mv_test;
SQL SUCCESS
alter materialized view student_mv owner to current_user;
?.*ERROR: syntax error at or near "current_user"
?.*Position:?.*
alter materialized view student_mv owner to session_user;
?.*ERROR: syntax error at or near "session_user"
?.*Position:?.*
--修改物化视图列名
alter materialized view student_mv rename column id to id_new;
SQL SUCCESS
select * from student_mv;
+--------+------+
| id_new | name |
+--------+------+
| 1      | aaa  |
| 2      | bbb  |
| 3      | ccc  |
| 4      | ddd  |
| 5      | eee  |
| 6      | fff  |
+--------+------+
--修改物化视图名
alter materialized view student_mv rename to student_mv_new;
SQL SUCCESS
select * from student_mv_new;
+--------+------+
| id_new | name |
+--------+------+
| 1      | aaa  |
| 2      | bbb  |
| 3      | ccc  |
| 4      | ddd  |
| 5      | eee  |
| 6      | fff  |
+--------+------+
--检查下对关键字的屏蔽，期望报错
alter materialized view student_mv rename column id to rownum;
?.*ERROR: syntax error at or near "rownum"
?.*Position:?.*
--error
alter materialized view student_mv rename to user;
?.*ERROR: syntax error at or near "user"
?.*Position:?.*
--error
--修改物化视图模式
drop schema if exists mv_schema cascade;
SQL SUCCESS
create schema mv_schema;
SQL SUCCESS
alter materialized view student_mv_new set schema mv_schema;
SQL SUCCESS
select schemaname, matviewname from pg_matviews where matviewname = 'student_mv_new';
+------------+----------------+
| schemaname | matviewname    |
+------------+----------------+
| mv_schema  | student_mv_new |
+------------+----------------+
--修改物化视图表空间
drop tablespace if exists mv_space;
SQL SUCCESS
create tablespace mv_space relative location 'postgres_tbs';
SQL SUCCESS
alter materialized view mv_schema.student_mv_new set tablespace mv_space;
SQL SUCCESS
select spcname from pg_tablespace where oid = (select reltablespace from pg_class where relname = 'student_mv_new');
+----------+
| spcname  |
+----------+
| mv_space |
+----------+
--增加物化视图列
alter materialized view mv_schema.student_mv_new add column id_new;
?.*ERROR: syntax error at end of input
?.*Position:?.*
--error
--删除物化视图列
alter materialized view student_mv drop column id int;
?.*ERROR: syntax error at or near "int"
?.*Position:?.*
--error
drop materialized view mv_schema.student_mv_new cascade;
SQL SUCCESS
drop tablespace mv_space;
SQL SUCCESS
drop schema mv_schema;
SQL SUCCESS
drop user mv_test;
SQL SUCCESS
